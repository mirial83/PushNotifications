<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PushNotifications - Password Reset Required</title>
    <link rel="icon" type="image/png" href="pnicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="login-body">
    <div class="login-container">
        <div class="login-form">
            <div class="form-header">
                <h1>üîí Password Reset Required</h1>
                <p class="subtitle">Your administrator has set a temporary password for your account. Please create a new secure password to continue.</p>
            </div>
            
            <form id="passwordResetForm" class="password-reset-form">
                <div class="form-group">
                    <label for="currentPassword">Current Password:</label>
                    <div class="password-input-group">
                        <input type="password" id="currentPassword" name="currentPassword" 
                               placeholder="Enter your temporary password" required>
                        <button type="button" class="show-password-btn" onclick="togglePasswordVisibility('currentPassword')">üëÅÔ∏è</button>
                    </div>
                    <small>This is the temporary password provided by your administrator</small>
                </div>
                
                <div class="form-group">
                    <label for="newPassword">New Password:</label>
                    <div class="password-input-group">
                        <input type="password" id="newPassword" name="newPassword" 
                               placeholder="Create a secure new password" required minlength="12">
                        <button type="button" class="show-password-btn" onclick="togglePasswordVisibility('newPassword')">üëÅÔ∏è</button>
                    </div>
                    <div id="passwordStrength" class="password-strength"></div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password:</label>
                    <div class="password-input-group">
                        <input type="password" id="confirmPassword" name="confirmPassword" 
                               placeholder="Confirm your new password" required minlength="12">
                        <button type="button" class="show-password-btn" onclick="togglePasswordVisibility('confirmPassword')">üëÅÔ∏è</button>
                    </div>
                </div>
                
                <!-- Password Requirements -->
                <div class="password-requirements">
                    <h4>Password Requirements:</h4>
                    <div class="requirements-list">
                        <div class="requirement" data-requirement="length">‚úó At least 12 characters</div>
                        <div class="requirement" data-requirement="uppercase">‚úó At least one uppercase letter</div>
                        <div class="requirement" data-requirement="lowercase">‚úó At least one lowercase letter</div>
                        <div class="requirement" data-requirement="number">‚úó At least one number</div>
                        <div class="requirement" data-requirement="symbol">‚úó At least one symbol (!@#$%^&*)</div>
                        <div class="requirement" data-requirement="unique">‚úó No repeated characters</div>
                    </div>
                </div>
                
                <div class="password-tips">
                    <h4>üí° Password Tips:</h4>
                    <ul>
                        <li>Use a mix of uppercase and lowercase letters</li>
                        <li>Include numbers and special symbols</li>
                        <li>Make it at least 12 characters long</li>
                        <li>Each character should be unique (no repeats)</li>
                        <li>Consider using a passphrase with symbols and numbers</li>
                    </ul>
                </div>
                
                <div class="form-actions">
                    <button type="submit" id="resetPasswordBtn" class="btn-primary" disabled>
                        <span class="btn-text">Reset Password</span>
                        <div class="btn-loading hidden">
                            <div class="loading-spinner"></div>
                            <span>Resetting...</span>
                        </div>
                    </button>
                </div>
                
                <div id="resetResult" class="form-result"></div>
            </form>
            
            <div class="form-footer">
                <p><a href="index.html" class="back-to-login">‚Üê Back to Login</a></p>
            </div>
        </div>
    </div>

    <script>
        // Password validation and UI logic
        let sessionToken = localStorage.getItem('sessionToken');
        
        // If no session token, redirect to login
        if (!sessionToken) {
            window.location.href = 'index.html';
        }
        
        // Password requirement validation
        function validatePassword(password) {
            const requirements = {
                length: password.length >= 12,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                symbol: /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password),
                unique: new Set(password.split('')).size === password.length
            };
            
            return requirements;
        }
        
        // Update requirement indicators
        function updatePasswordRequirements(password) {
            const requirements = validatePassword(password);
            
            Object.keys(requirements).forEach(req => {
                const element = document.querySelector(`[data-requirement="${req}"]`);
                if (element) {
                    if (requirements[req]) {
                        element.classList.add('met');
                        element.textContent = element.textContent.replace('‚úó', '‚úì');
                    } else {
                        element.classList.remove('met');
                        element.textContent = element.textContent.replace('‚úì', '‚úó');
                    }
                }
            });
            
            return Object.values(requirements).every(met => met);
        }
        
        // Password strength indicator
        function updatePasswordStrength(password) {
            const strengthEl = document.getElementById('passwordStrength');
            const requirements = validatePassword(password);
            const metCount = Object.values(requirements).filter(met => met).length;
            
            let strength = 'Very Weak';
            let className = 'very-weak';
            
            if (metCount === 6) {
                strength = 'Very Strong';
                className = 'very-strong';
            } else if (metCount >= 5) {
                strength = 'Strong';
                className = 'strong';
            } else if (metCount >= 4) {
                strength = 'Good';
                className = 'good';
            } else if (metCount >= 3) {
                strength = 'Fair';
                className = 'fair';
            } else if (metCount >= 2) {
                strength = 'Weak';
                className = 'weak';
            }
            
            strengthEl.innerHTML = `<span class="strength-indicator ${className}">Strength: ${strength}</span>`;
            return metCount === 6;
        }
        
        // Toggle password visibility
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }
        
        // Enable/disable submit button
        function updateSubmitButton() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const resetBtn = document.getElementById('resetPasswordBtn');
            
            const passwordValid = updatePasswordRequirements(newPassword);
            const passwordsMatch = newPassword === confirmPassword && newPassword.length > 0;
            const hasCurrentPassword = currentPassword.length > 0;
            
            resetBtn.disabled = !(passwordValid && passwordsMatch && hasCurrentPassword);
        }
        
        // Event listeners
        document.getElementById('newPassword').addEventListener('input', function() {
            updatePasswordStrength(this.value);
            updatePasswordRequirements(this.value);
            updateSubmitButton();
        });
        
        document.getElementById('confirmPassword').addEventListener('input', updateSubmitButton);
        document.getElementById('currentPassword').addEventListener('input', updateSubmitButton);
        
        // Form submission
        document.getElementById('passwordResetForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resultDiv = document.getElementById('resetResult');
            const resetBtn = document.getElementById('resetPasswordBtn');
            
            // Show loading state
            resetBtn.querySelector('.btn-text').style.display = 'none';
            resetBtn.querySelector('.btn-loading').classList.remove('hidden');
            resetBtn.disabled = true;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                resultDiv.innerHTML = '<div class="error-message">Passwords do not match</div>';
                resetBtn.querySelector('.btn-text').style.display = 'inline';
                resetBtn.querySelector('.btn-loading').classList.add('hidden');
                resetBtn.disabled = false;
                return;
            }
            
            try {
                const response = await fetch('/api/index', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({
                        action: 'resetOwnPassword',
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = '<div class="success-message">Password reset successful! Redirecting to admin panel...</div>';
                    
                    // Redirect after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'admin.html';
                    }, 2000);
                } else {
                    resultDiv.innerHTML = `<div class="error-message">${result.message}</div>`;
                    resetBtn.querySelector('.btn-text').style.display = 'inline';
                    resetBtn.querySelector('.btn-loading').classList.add('hidden');
                    resetBtn.disabled = false;
                }
            } catch (error) {
                console.error('Password reset error:', error);
                resultDiv.innerHTML = '<div class="error-message">Network error. Please try again.</div>';
                resetBtn.querySelector('.btn-text').style.display = 'inline';
                resetBtn.querySelector('.btn-loading').classList.add('hidden');
                resetBtn.disabled = false;
            }
        });
    </script>
</body>
</html>